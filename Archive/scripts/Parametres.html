<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Paramètres</title>
    <style>
      /* Global Styles */
      body {
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        background: #f9f9f9;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      h3 {
        color: #444;
        margin-top: 0;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
      }
      p {
        line-height: 1.6;
      }
      
      /* Tab Menu Styles */
      .tab-menu {
        margin-bottom: 20px;
      }
      .tab-menu button {
        background-color: #007BFF;
        border: none;
        color: #fff;
        padding: 10px 20px;
        margin-right: 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s ease;
      }
      .tab-menu button:hover {
        background-color: #0056b3;
      }
      
      /* Tab Content Styles */
      .tab {
        display: none;
        background: #fff;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }
      .tab.active {
        display: block;
      }
      
      /* Form Elements */
      input[type="text"],
      input[type="date"],
      select,
      textarea {
        width: 100%;
        padding: 8px;
        margin: 4px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
      }
      
      /* Table Styling */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      table, th, td {
        border: 1px solid #ccc;
      }
      th, td {
        padding: 10px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      tr:nth-child(even) {
        background-color: #fafafa;
      }
      
      /* Buttons */
      button {
        background-color: #28a745;
        border: none;
        color: #fff;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #218838;
      }
      /* Special styling for delete buttons */
      button.delete {
        background-color: #dc3545;
      }
      button.delete:hover {
        background-color: #c82333;
      }
      
      /* Specific styles for link inputs */
      .liensContainer input[type="text"] {
        display: inline-block;
        width: auto;
        margin-right: 10px;
      }
    </style>
    <script>
      // Variable globale pour stocker la liste d’articles uniques
      window.listeArticles = [];

      // Affiche l'onglet sélectionné
      function showTab(tabId) {
        var tabs = document.getElementsByClassName('tab');
        for (var i = 0; i < tabs.length; i++) {
          tabs[i].classList.remove('active');
        }
        document.getElementById(tabId).classList.add('active');
      }
      
  function loadParams() {
    // 1) Charger la liste des articles
    google.script.run.withSuccessHandler(function(liste) {
      // Stocker la liste dans la variable globale
      window.listeArticles = liste;

      // 2) Maintenant qu'on a la liste, on récupère les paramètres
      google.script.run.withSuccessHandler(function(params) {
        // Affecter les valeurs récupérées aux champs du formulaire
        document.getElementById('idDossier').value = params.idDossier;
        document.getElementById('nomFichierInscriptions').value = params.nomFichierInscriptions;
        document.getElementById('nomFichierArticles').value = params.nomFichierArticles;
        
        var tbody = document.getElementById('reglesTbody');
        tbody.innerHTML = "";
        params.reglesArticles.forEach(function(regle) {
          ajouterLigneTable(regle.article, regle.annees.join(","));
        });
        
        // Gérer le checkDuplicates, checkCDPConflict, etc.
        document.getElementById('checkDuplicates').checked = params.checkDuplicates;
        document.getElementById('checkCDPConflict').checked = params.checkCDPConflict;
        document.getElementById('debugActif').checked = params.debugActif;
      }).getParametres();

    }).getListeArticlesUnique();
  }

      // Ajoute une ligne au tableau (sélecteur d’article + années autorisées)
      function ajouterLigneTable(article, annees) {
        var tbody = document.getElementById('reglesTbody');
        var tr = document.createElement('tr');
        
        // Cellule Article avec <select>
        var tdArticle = document.createElement('td');
        var selectArticle = document.createElement('select');
        selectArticle.className = 'article';
        
        // Option vide
        var optVide = document.createElement('option');
        optVide.value = "";
        optVide.textContent = "-- Choisir un article --";
        selectArticle.appendChild(optVide);
        
        // Remplir le <select> avec la liste d’articles
        window.listeArticles.forEach(function(item) {
          var opt = document.createElement('option');
          opt.value = item;
          opt.textContent = item;
          selectArticle.appendChild(opt);
        });
        
        if (article) {
          selectArticle.value = article;
        }
        tdArticle.appendChild(selectArticle);
        tr.appendChild(tdArticle);
        
        // Cellule Années autorisées
        var tdAnnees = document.createElement('td');
        var inputAnnees = document.createElement('input');
        inputAnnees.type = 'text';
        inputAnnees.value = annees || "";
        inputAnnees.placeholder = "Ex: 2013,2014,2015";
        inputAnnees.className = 'annees';
        tdAnnees.appendChild(inputAnnees);
        tr.appendChild(tdAnnees);
        
        // Cellule Actions
        var tdActions = document.createElement('td');
        var btnSupprimer = document.createElement('button');
        btnSupprimer.textContent = "Supprimer";
        btnSupprimer.className = "delete";
        btnSupprimer.onclick = function() {
          tbody.removeChild(tr);
        };
        tdActions.appendChild(btnSupprimer);
        tr.appendChild(tdActions);
        
        tbody.appendChild(tr);
      }
      
      // Ajoute une nouvelle ligne vide
      function ajouterNouvelleLigne() {
        ajouterLigneTable("", "");
      }
      
      // Sauvegarde tous les paramètres
      function saveParams() {
        var idDossier = document.getElementById('idDossier').value.trim();
        var nomFichierInscriptions = document.getElementById('nomFichierInscriptions').value.trim();
        var nomFichierArticles = document.getElementById('nomFichierArticles').value.trim();
        var debugActif = document.getElementById('debugActif').checked;
        
        var checkDuplicates = document.getElementById('checkDuplicates').checked;
        var checkCDPConflict = document.getElementById('checkCDPConflict').checked;
        
        var tbody = document.getElementById('reglesTbody');
        var regles = [];
        var rows = tbody.getElementsByTagName('tr');
        for (var i = 0; i < rows.length; i++) {
          var select = rows[i].querySelector('.article');
          var inputAnnees = rows[i].querySelector('.annees');
          
          var articleChoisi = select.value.trim();
          var anneesStr = inputAnnees.value.trim();
          if (articleChoisi && anneesStr) {
            var anneesArr = anneesStr.split(',').map(function(a) {
              return parseInt(a.trim(), 10);
            }).filter(function(n) { return !isNaN(n); });
            regles.push({ article: articleChoisi, annees: anneesArr });
          }
        }
        
        var paramsObj = {
          idDossier: idDossier,
          nomFichierInscriptions: nomFichierInscriptions,
          nomFichierArticles: nomFichierArticles,
          debugActif: debugActif,
          checkDuplicates: checkDuplicates,
          checkCDPConflict: checkCDPConflict,
          reglesArticles: regles
        };
        
        google.script.run.withSuccessHandler(function(response) {
          alert(response);
        }).sauvegarderParametres(paramsObj);
      }
      
      window.onload = loadParams;
    </script>
  </head>
  <body>
    <div class="tab-menu">
      <button onclick="showTab('general')">Général</button>
      <button onclick="showTab('erreurs')">Détection d'erreurs</button>
      <!-- Correction ici : appel de la fonction ajouterSuivisCourriel() -->
      <button onclick="showTab('suivisCourriel')">Suivi courriel</button>
      <button onclick="showTab('debug')">Debug / Notifications</button>
    </div>
    
    <!-- Onglet Général -->
    <div id="general" class="tab active">
      <h3>Paramètres Généraux</h3>
      <p>Ces paramètres concernent les fichiers exportés depuis Spordle qui sont convertis pour mettre à jour les onglets INSCRIPTIONS et ARTICLES.</p>
      <label for="idDossier">ID du dossier source :</label><br/>
      <input type="text" id="idDossier" placeholder="Ex: 14uQ6HHVS9y4K00iNPJVF5nAxuTenb5wk"/><br/><br/>
      
      <label for="nomFichierInscriptions">Nom du fichier Inscriptions :</label><br/>
      <input type="text" id="nomFichierInscriptions" placeholder="Ex: inscriptions.xlsx"/><br/><br/>
      
      <label for="nomFichierArticles">Nom du fichier Articles :</label><br/>
      <input type="text" id="nomFichierArticles" placeholder="Ex: articles.xlsx"/><br/><br/>
    </div>

    <!-- Onglet Suivis Courriel -->
    <div id="suivisCourriel" class="tab">
      <h3>Suivis Courriel</h3>
      <!-- Correction : appel de la fonction avec le bon nom -->
      <button onclick="ajouterSuivisCourriel()">Ajouter un nouveau suivi courriel</button>
      <table>
        <thead>
          <tr>
            <th>Secteur</th>
            <th>Adresse courriel</th>
            <th>Liens</th>
            <th>Message</th>
            <th>Date d'inscription butoir</th>
            <th>Simulation (Mode test + courriel de test)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="suivisCourrielTbody"></tbody>
      </table>
      <br/>
      <button onclick="saveSuivisCourriel()">Sauvegarder les suivis courriel</button>
    </div>
    
    <script>
      // Chargement des paramètres de suivis courriel lors du chargement du popup
      function loadSuivisCourriel() {
        google.script.run.withSuccessHandler(function(suivis) {
          var tbody = document.getElementById('suivisCourrielTbody');
          tbody.innerHTML = "";
          suivis.forEach(function(suivi) {
            ajouterSuivisCourriel(suivi);
          });
        }).getSuivisCourriel();
      }

      // Ajoute une nouvelle ligne (avec éventuellement des données préchargées)
      function ajouterSuivisCourriel(suiviData) {
        var tbody = document.getElementById('suivisCourrielTbody');
        var tr = document.createElement('tr');

        // Cellule Secteur : dropdown avec nouvelles options
        var tdSecteur = document.createElement('td');
        var selectSecteur = document.createElement('select');
        ["U4-U6","U7-U8","U9", "U10", "U11", "U12", "U13", "U13-U15", "U14-U15", "U16-U19"].forEach(function(optText) {
          var opt = document.createElement('option');
          opt.value = optText;
          opt.textContent = optText;
          selectSecteur.appendChild(opt);
        });
        if (suiviData && suiviData.secteur) {
          selectSecteur.value = suiviData.secteur;
        }
        tdSecteur.appendChild(selectSecteur);
        tr.appendChild(tdSecteur);

        // Cellule Adresse courriel
        var tdEmail = document.createElement('td');
        var inputEmail = document.createElement('input');
        inputEmail.type = 'text';
        inputEmail.placeholder = "ex: responsable@csrq.qc.ca, second@csrq.qc.ca";
        inputEmail.style.width = "150px";
        if (suiviData && suiviData.email) {
          inputEmail.value = suiviData.email;
        }
        tdEmail.appendChild(inputEmail);
        tr.appendChild(tdEmail);

        // Cellule Liens : possibilité d'ajouter plusieurs URL et leur libellé
        var tdLiens = document.createElement('td');
        var divLiens = document.createElement('div');
        divLiens.className = 'liensContainer';
        if (suiviData && suiviData.liens) {
          suiviData.liens.forEach(function(lien) {
            ajouterLigneLien(divLiens, lien);
          });
        }
        var btnAjouterLien = document.createElement('button');
        btnAjouterLien.textContent = "Ajouter un lien URL";
        btnAjouterLien.onclick = function() {
          ajouterLigneLien(divLiens);
        };
        tdLiens.appendChild(divLiens);
        tdLiens.appendChild(btnAjouterLien);
        tr.appendChild(tdLiens);

        // Cellule Message : zone de texte pour composer le message
        var tdMessage = document.createElement('td');
        var txtMessage = document.createElement('textarea');
        txtMessage.rows = 4;
        txtMessage.cols = 30;
        txtMessage.placeholder = "Composez ici le message à envoyer (texte, accents, etc.)";
        if (suiviData && suiviData.message) {
          txtMessage.value = suiviData.message;
        }
        tdMessage.appendChild(txtMessage);
        tr.appendChild(tdMessage);

        // Cellule Date d'inscription butoir : input type date
        var tdDate = document.createElement('td');
        var inputDate = document.createElement('input');
        inputDate.type = 'date';
        if (suiviData && suiviData.dateButoir) {
          inputDate.value = suiviData.dateButoir;
        }
        tdDate.appendChild(inputDate);
        tr.appendChild(tdDate);

        // Cellule Simulation : case à cocher et champ pour courriel de test
        var tdSimulation = document.createElement('td');
        var labelSim = document.createElement('label');
        var checkSim = document.createElement('input');
        checkSim.type = 'checkbox';
        checkSim.style.marginRight = "4px";
        if (suiviData && suiviData.simulation === true) {
          checkSim.checked = true;
        }
        labelSim.appendChild(checkSim);
        labelSim.appendChild(document.createTextNode("Test"));
        tdSimulation.appendChild(labelSim);
        var inputTestEmail = document.createElement('input');
        inputTestEmail.type = 'text';
        inputTestEmail.placeholder = "Courriel de test";
        inputTestEmail.style.width = "150px";
        if (suiviData && suiviData.testEmail) {
          inputTestEmail.value = suiviData.testEmail;
        }
        tdSimulation.appendChild(document.createElement('br'));
        tdSimulation.appendChild(inputTestEmail);
        tr.appendChild(tdSimulation);

        // Cellule Actions : bouton Supprimer
        var tdActions = document.createElement('td');
        var btnSupprimer = document.createElement('button');
        btnSupprimer.textContent = "Supprimer";
        btnSupprimer.className = "delete";
        btnSupprimer.onclick = function() {
          tbody.removeChild(tr);
        };
        tdActions.appendChild(btnSupprimer);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      }

      // Ajoute une nouvelle ligne de lien (URL et libellé) dans le conteneur donné
      function ajouterLigneLien(container, lienData) {
        var div = document.createElement('div');
        div.style.marginBottom = "4px";
        
        var inputNom = document.createElement('input');
        inputNom.type = 'text';
        inputNom.placeholder = "Nom du lien";
        inputNom.style.width = "100px";
        if (lienData && lienData.nom) {
          inputNom.value = lienData.nom;
        }
        div.appendChild(inputNom);

        var inputURL = document.createElement('input');
        inputURL.type = 'text';
        inputURL.placeholder = "URL";
        inputURL.style.width = "150px";
        if (lienData && lienData.url) {
          inputURL.value = lienData.url;
        }
        div.appendChild(inputURL);

        var btnRetirer = document.createElement('button');
        btnRetirer.textContent = "Retirer";
        btnRetirer.className = "delete";
        btnRetirer.onclick = function() {
          container.removeChild(div);
        };
        div.appendChild(btnRetirer);

        container.appendChild(div);
      }

      // Sauvegarde tous les suivis courriel configurés
      function saveSuivisCourriel() {
        var tbody = document.getElementById('suivisCourrielTbody');
        var rows = tbody.getElementsByTagName('tr');
        var suivis = [];
        for (var i = 0; i < rows.length; i++) {
          var cells = rows[i].getElementsByTagName('td');
          var secteur = cells[0].querySelector('select').value;
          var email = cells[1].querySelector('input').value.trim();
          
          // Récupérer les liens
          var liens = [];
          var liensContainer = cells[2].querySelector('.liensContainer');
          var divs = liensContainer.querySelectorAll('div');
          divs.forEach(function(div) {
            var inputs = div.getElementsByTagName('input');
            var nomLien = inputs[0].value.trim();
            var urlLien = inputs[1].value.trim();
            if (nomLien && urlLien) {
              liens.push({ nom: nomLien, url: urlLien });
            }
          });
          
          var message = cells[3].querySelector('textarea').value;
          var dateButoir = cells[4].querySelector('input').value;
          var simulation = cells[5].querySelector('input[type="checkbox"]').checked;
          var testEmail = cells[5].querySelector('input[type="text"]').value.trim();
          
          suivis.push({
            secteur: secteur,
            email: email,
            liens: liens,
            message: message,
            dateButoir: dateButoir,
            simulation: simulation,
            testEmail: testEmail
          });
        }
        google.script.run.withSuccessHandler(function(resp) {
          alert(resp);
        }).sauvegarderSuivisCourriel(suivis);
      }

      // Au chargement de la page, charger aussi les suivis courriel enregistrés
      window.onload = function() {
        loadParams();
        loadSuivisCourriel();
      };
    </script>
    
    <!-- Onglet Détection d'erreurs -->
    <div id="erreurs" class="tab">
      <h3>Détection d'erreurs</h3>
      <p>
        <label>
          <input type="checkbox" id="checkDuplicates" />
          Gérer les doublons (interdire plusieurs occurrences du même article pour un même membre)
        </label>
        <br/>
        <label>
          <input type="checkbox" id="checkCDPConflict" />
          Gérer le conflit entre "1" et "2" entraînements CDP (U9-U12)
        </label>
      </p>
      
      <p>Ajoutez ici les règles d'association entre un article et les années autorisées.</p>
      <button onclick="ajouterNouvelleLigne()">Ajouter une règle</button>
      <table>
        <thead>
          <tr>
            <th>Article</th>
            <th>Années autorisées (séparées par des virgules)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reglesTbody"></tbody>
      </table>
    </div>
    
    <!-- Onglet Debug / Notifications -->
    <div id="debug" class="tab">
      <h3>Debug et Notifications</h3>
      <label>
        <input type="checkbox" id="debugActif" />
        Activer les logs détaillés / popup multiples
      </label>
    </div>
    
    <br/>
    <button onclick="saveParams()">Sauvegarder les paramètres</button>
  </body>
</html>
