<script>// ===== PARAMS (UI structurée / titres humains) =====
const PARAM_GROUPS = [
  { id:'import', label:'Imports' },
  { id:'diff', label:'Incrémental & Clés' },
  { id:'annul', label:'Annulations' },
  { id:'mail', label:'Courriel — Global' },
  { id:'mail-new', label:'Courriel — Nouvelles inscriptions' },
  { id:'mail-sum', label:'Courriel — Résumés par secteur' },
  { id:'rules', label:'Paramètres Règles' },
  { id:'retro-m', label:'Rétro — Membres' },
  { id:'retro-g', label:'Rétro — Groupes' },
  { id:'retro-ga', label:'Rétro — Groupe Articles' },
  { id:'season', label:'Saison' },            // ← AJOUTÉ
  { id:'others', label:'Autres' },
];


// Titre & aide par clé
const PARAM_META = {

  DRIVE_FOLDER_VALIDATION_MEMBRES: { 
    group:'import', 
    title:'Dossier Drive Validation_Membres',
    desc:'ID du dossier Drive contenant le fichier Validation_Membres (1 fichier actif + sous-dossier Archives)' 
  },
  SHEET_MEMBRES_GLOBAL: { 
    group:'import', 
    title:'Feuille MEMBRES_GLOBAL',
    desc:'Nom de la feuille centrale qui contient les membres avec expiration photo/casier'
  },
  SEASON_YEAR: { 
    group:'season', 
    title:'Année de saison courante',
    desc:'Année utilisée pour invalider les photos (ex. 2025)'
  },
  PHOTO_INVALID_FROM_MMDD: { 
    group:'season', 
    title:'Date de début invalidité photo',
    desc:'Mois-jour à partir duquel les photos expirant dans l’année deviennent invalides (ex. 04-01)'
  },
  MAIL_USE_GMAILAPP: {
  group:'mail',
  title:'Utiliser GmailApp',
  help:'TRUE ➜ GmailApp (labels/filtres Gmail possibles). FALSE ➜ MailApp.'
},
DRY_REDIRECT_EMAIL: {
  group:'mail',
  title:'Redirection en mode DRY_RUN',
  help:'Si DRY_RUN=TRUE, tous les envois sont redirigés vers cette adresse.'
},

// --- Rétro — Membres ---
RETRO_COACH_FEES_CSV: {
  group:'retro-m',
  title:'Frais « entraîneur/coach »',
  help:'Liste CSV. Ces frais seront exclus des règles joueurs et des exports membres.'
},

// --- Règles (optionnel) ---
RETRO_RULES_JSON: {
  group:'rules',
  title:'Règles JSON (RETRO_RULES_JSON)',
  help:'JSON brut des règles. Laisse vide pour utiliser les valeurs PARAMS par défaut.'
},

  // Imports
  DRIVE_FOLDER_IMPORTS: { group:'import', title:'Dossier Drive des imports', help:'ID du dossier Drive contenant les fichiers sources à importer.' },
  FILE_PATTERN_INSCRIPTIONS: { group:'import', title:'Filtre fichiers — Inscriptions', help:'Sous-chaîne à trouver dans les noms de fichiers.' },
  FILE_PATTERN_ARTICLES: { group:'import', title:'Filtre fichiers — Articles', help:'Sous-chaîne à trouver dans les noms de fichiers.' },
  // Diff & clés
  DRY_RUN: { group:'diff', title:'Mode simulation (dry-run)', help:'Aucune écriture ni email — journalisation seulement.' },
  MOVE_CONVERTED_TO_ARCHIVE: { group:'diff', title:'Archiver les fichiers convertis', help:'Déplace vers Archives/YYYY-MM-DD.' },
  INCREMENTAL_ON: { group:'diff', title:'Import incrémental', help:'Idempotent — ajoute/met à jour sans tout réécrire.' },
  KEY_COLS: { group:'diff', title:'Clé d’unicité', help:'Colonnes exactes (entêtes) séparées par des virgules.' },
  SEASON_LABEL: { group:'diff', title:'Libellé humain de la saison', help:'Ex. 2025-Aut-Hiv (affichage/exports).' },
  

  // Annulations
  ANNULATIONS_ACTIVE: { group:'annul', title:'Activer le traitement des annulations', help:'Met à jour flags + logs ANNULATIONS_*.' },
  STATUS_COL_INSCRIPTIONS: { group:'annul', title:'Colonne statut — INSCRIPTIONS', help:'Nom exact de la colonne.' },
  STATUS_COL_ARTICLES: { group:'annul', title:'Colonne statut — ARTICLES', help:'Nom exact de la colonne.' },
  STATUS_CANCEL_VALUES: { group:'annul', title:'Valeurs d’annulation', help:'Liste de valeurs (séparées par virgules) considérées comme « annulé ».' },
  STATUS_CANCEL_DATE_COL: { group:'annul', title:'Colonne date d’annulation', help:'Nom exact (optionnel).' },
  // Courriel global
  MAIL_FROM: { group:'mail', title:'Alias d’expédition', help:'Alias Gmail configuré (sinon laisser vide).' },
  MAIL_BATCH_MAX: { group:'mail', title:'Taille de lot d’envois', help:'Nombre max de mails traités par exécution.' },
  TO_FIELDS_INSCRIPTIONS: { group:'mail', title:'Champs emails (membre)', help:'Entêtes à concaténer (séparées par virgules). Déduplication automatique.' },
  // Nouvelles inscriptions
  MAIL_TO_NEW_INSCRIPTIONS: { group:'mail-new', title:'Destinataires — Confirmation', help:'Fallback si la ligne n’a aucun courriel. Séparer par des virgules.' },
  MAIL_CC_NEW_INSCRIPTIONS: { group:'mail-new', title:'CC — Confirmation', help:'Optionnel. Séparer par des virgules.' },
  MAIL_TEMPLATE_INSCRIPTION_NEW_SUBJECT: { group:'mail-new', title:'Sujet — Confirmation', help:'Placeholders : {{prenom}}, {{nom}}, {{frais}}, {{saison}}, {{categorie}}, {{secteur}}.' },
  MAIL_TEMPLATE_INSCRIPTION_NEW_BODY: { group:'mail-new', title:'Corps HTML — Confirmation', help:'HTML autorisé.' },
  // Résumés secteur
  MAIL_TO_SUMMARY_U4U8: { group:'mail-sum', title:'Destinataires — Résumé U4-U8', help:'Séparer plusieurs emails par des virgules.' },
  MAIL_CC_SUMMARY_U4U8: { group:'mail-sum', title:'CC — Résumé U4-U8', help:'Optionnel.' },
  MAIL_TO_SUMMARY_U9U12: { group:'mail-sum', title:'Destinataires — Résumé U9-U12', help:'Séparer par virgules.' },
  MAIL_CC_SUMMARY_U9U12: { group:'mail-sum', title:'CC — Résumé U9-U12', help:'Optionnel.' },
  MAIL_TO_SUMMARY_U13U18: { group:'mail-sum', title:'Destinataires — Résumé U13-U18', help:'Séparer par virgules.' },
  MAIL_CC_SUMMARY_U13U18: { group:'mail-sum', title:'CC — Résumé U13-U18', help:'Optionnel.' },
  MAIL_TEMPLATE_SUMMARY_SUBJECT: { group:'mail-sum', title:'Sujet — Résumé secteur', help:'Placeholders : {{secteur}}, {{date}}.' },
  MAIL_TEMPLATE_SUMMARY_BODY: { group:'mail-sum', title:'Corps HTML — Résumé secteur', help:'HTML autorisé.' },
  // Paramètres Règles
  RULES_ON: { group:'rules', title:'Activer l’évaluation des règles', help:'Remplit la feuille ERREURS.' },
  RULES_SEVERITY_THRESHOLD: { group:'rules', title:'Seuil de sévérité', help:'warn | error.' },
  RULES_APPEND: { group:'rules', title:'Mode append sur ERREURS', help:'Sinon réinitialise la feuille avant d’écrire.' },
  RULES_DRY_RUN: { group:'rules', title:'Règles en simulation', help:'Aucune écriture/flags/outbox.' },
  RULES_MAX_ROWS: { group:'rules', title:'Garde-fou performances', help:'Nb max de lignes traitées par passe règles.' },
  // Rétro — Membres
  EXPORT_MODIFIED_SINCE_DAYS: { group:'retro-m', title:'Inscriptions modifiées depuis (jours)', help:'Pour MAJ dans Rétroaction.' },
  RETRO_IGNORE_FEES_CSV: { group:'retro-m', title:'Frais à ignorer (membres)', help:'Insensible casse/accents. Virgules.' },
  RETRO_ADAPTE_KEYWORDS: { group:'retro-m', title:'Mots-clés « Adapté »', help:'Virgules.' },
  RETRO_CAMP_KEYWORDS: { group:'retro-m', title:'Mots-clés « Camp U13 »', help:'Virgules.' },
  RETRO_MUTATION_SHEET: { group:'retro-m', title:'Feuille des passeports « mutés »', help:'Nom de feuille, col A.' },
  RETRO_EXPORTS_FOLDER_ID: { group:'retro-m', title:'Dossier Drive — Exports', help:'XLSX cible (sinon racine).' },
  RETRO_PHOTO_INCLUDE_COL: { group:'retro-m', title:'Inclure la colonne Photo', help:'Ajoute une colonne « Photo ».' },
  RETRO_PHOTO_EXPIRY_COL: { group:'retro-m', title:'Col. date d’expiration photo', help:'Nom exact (INSCRIPTIONS).' },
  RETRO_PHOTO_WARN_ABS_DATE: { group:'retro-m', title:'Date absolue — Avertir avant', help:'YYYY-MM-DD (optionnel).' },
  RETRO_PHOTO_WARN_BEFORE_MMDD: { group:'retro-m', title:'Avertir avant (MM-DD)', help:'Relatif à l’année de SEASON_LABEL.' },
  RETRO_EXCLUDE_MEMBER_IF_ONLY_IGN: { group:'retro-m', title:'Exclure membres « frais ignorés »', help:'Si un membre n’a que des frais ignorés.' },
  RETRO_MEMBER_MAX_U: { group:'retro-m', title:'Âge max “jeune” (U)', help:'Optionnel pour la validation: > valeur = adultes (ignorés par le test).' },
 
  // Rétro — Groupes
  RETRO_GROUP_SHEET_NAME: { group:'retro-g', title:'Nom de feuille — Groupes', help:'Feuille de sortie.' },
  RETRO_GROUP_EXPORTS_FOLDER_ID: { group:'retro-g', title:'Dossier Drive — Groupes', help:'XLSX; défaut = RETRO_EXPORTS_FOLDER_ID.' },
  RETRO_GROUP_ELITE_KEYWORDS: { group:'retro-g', title:'Clés « élite » à exclure', help:'Virgules.' },
  RETRO_GROUP_SA_KEYWORDS: { group:'retro-g', title:'Clés « soccer adapté »', help:'Virgules.' },
  RETRO_GROUP_SA_GROUPE_LABEL: { group:'retro-g', title:'Libellé groupe — Adapté', help:'Texte si adapté détecté.' },
  RETRO_GROUP_SA_CATEG_LABEL: { group:'retro-g', title:'Libellé catégorie — Adapté', help:'Texte si adapté détecté.' },
  RETRO_GROUP_GROUPE_FMT: { group:'retro-g', title:'Format « Équipe/Groupe »', help:'Ex. {{U}}{{genreInitiale}}' },
  RETRO_GROUP_CATEGORIE_FMT: { group:'retro-g', title:'Format « Catégorie »', help:'Ex. {{U}} {{genreInitiale}}' },
  // Rétro — Groupe Articles
  RETRO_GART_SHEET_NAME: { group:'retro-ga', title:'Nom de feuille — Groupe Articles', help:'Feuille de sortie.' },
  RETRO_GART_EXPORTS_FOLDER_ID: { group:'retro-ga', title:'Dossier Drive — Groupe Articles', help:'XLSX; défaut = RETRO_EXPORTS_FOLDER_ID.' },
  RETRO_GART_IGNORE_FEES_CSV: { group:'retro-ga', title:'Articles à ignorer', help:'Virgules.' },
  RETRO_GART_ELITE_KEYWORDS: { group:'retro-ga', title:'Clés « élite » à exclure', help:'Virgules.' },
  RETRO_GART_REQUIRE_MAPPING: { group:'retro-ga', title:'Exiger un mapping valide', help:'N’écrire que si un mapping GROUPES_ARTICLES matche.' },
};


let _paramsLoadedForSeasonId = null;
let _paramsCache = { items: [], byKey: {} };

function typeToInput(entry) {
  const t = (entry.type || '').toLowerCase();
  const meta = PARAM_META[entry.key] || { group:'others', title: entry.key, help: entry.description || '' };
  const wrap = document.createElement('div'); wrap.className = 'field'; const id = 'param_' + entry.key; let control;

  if (t === 'boolean') { control = document.createElement('input'); control.type = 'checkbox'; control.id = id; control.checked = (String(entry.value).toLowerCase() === 'true'); }
  else if (t === 'int' || t === 'number') { control = document.createElement('input'); control.type = 'number'; control.id = id; control.value = (entry.value === undefined ? '' : entry.value); }
  else if (t === 'html') { control = document.createElement('textarea'); control.id = id; control.value = entry.value || ''; control.style.minHeight = '160px'; }
  else if (t === 'enum' && entry.key === 'RULES_SEVERITY_THRESHOLD') {
    control = document.createElement('select'); control.id = id; ['warn','error'].forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; control.appendChild(o); }); control.value = (entry.value || 'warn');
  } else { control = document.createElement('input'); control.type = 'text'; control.id = id; control.value = (entry.value === undefined ? '' : entry.value); }

  const title = document.createElement('h4'); title.textContent = meta.title;
  const desc = document.createElement('small'); const isCsv = /^csv/i.test(t) || t === 'email_list'; const hint = isCsv ? ' (plusieurs valeurs séparées par des virgules)' : '';
  desc.textContent = (meta.help || entry.description || '') + hint;

  wrap.appendChild(title); wrap.appendChild(control); wrap.appendChild(desc);
  wrap.dataset.key = entry.key; wrap.dataset.group = meta.group;
  return wrap;
}

function renderParams(detailed) {
  _paramsCache = detailed || { items:[] };
  const nav = $('#paramsNav'); const content = $('#paramsContent');
  nav.innerHTML=''; content.innerHTML='';
  const byKey = {}; (_paramsCache.items||[]).forEach(e => { byKey[e.key] = e; });

  const groupsMap = {}; PARAM_GROUPS.forEach(g => groupsMap[g.id] = { id:g.id, label:g.label, fields:[] });
  (_paramsCache.items||[]).forEach(e => {
    const meta = PARAM_META[e.key] || { group:'others' };
    const g = groupsMap[meta.group] || groupsMap['others'];
    g.fields.push(typeToInput(e));
  });

  const groups = Object.values(groupsMap).filter(g => g.fields.length);
  groups.forEach((g, idx) => {
    const b = document.createElement('button'); b.textContent = g.label; b.dataset.target = g.id; if (idx===0) b.classList.add('active'); nav.appendChild(b);
    const sec = document.createElement('div'); sec.className='section'; sec.id='section_'+g.id; if (idx!==0) sec.style.display='none';
    const title = document.createElement('h3'); title.textContent = g.label; sec.appendChild(title);
    g.fields.forEach(el => sec.appendChild(el)); content.appendChild(sec);
  });

  nav.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => {
    nav.querySelectorAll('button').forEach(x => x.classList.remove('active')); btn.classList.add('active');
    const tgt = btn.dataset.target; content.querySelectorAll('.section').forEach(s => s.style.display = (s.id === 'section_'+tgt ? 'block':'none'));
  }));
}

function loadParamsForActiveSeason(force) {
  const sid = $('#seasonSelect').value; if (!sid) return;
  if (!force && _paramsLoadedForSeasonId === sid) return;
  Busy.show('params', 'Chargement des paramètres…');
  google.script.run
    .withSuccessHandler(res => {
      if (!res.ok) { Busy.hide('params'); return toast(res.error); }
      renderParams(res.data);
      _paramsLoadedForSeasonId = sid;
      Busy.hide('params');
    })
    .withFailureHandler(err => { Busy.hide('params'); console.error('getParamsDetailed', err); toast('Erreur lecture Paramètres'); })
    .getParamsDetailed(sid);
}

// Recherche
$('#paramSearch').addEventListener('input', (e) => {
  const q = e.target.value.toLowerCase();
  $$('#paramsContent .field').forEach(f => {
    const title = (f.querySelector('h4')?.textContent||'').toLowerCase();
    const desc = (f.querySelector('small')?.textContent||'').toLowerCase();
    f.style.display = (title.includes(q) || desc.includes(q)) ? '' : 'none';
  });
});

$('#btnLoadParams').addEventListener('click', () => loadParamsForActiveSeason(true));

$('#btnSaveParams').addEventListener('click', () => {
  const sid = $('#seasonSelect').value; if (!sid) return toast('Sélectionne une saison');
  const btn = $('#btnSaveParams'); btn.disabled = true; Busy.show('params', 'Sauvegarde des paramètres…');
  const entries = [];
  $$('#paramsContent .field').forEach(f => {
    const key = f.dataset.key; const inp = f.querySelector('input,textarea,select');
    let val = (inp.type === 'checkbox') ? inp.checked : inp.value;
    const meta = _paramsCache.items.find(x => x.key === key) || { type: '' , description: '' };
    entries.push({ key, value: val, type: meta.type, description: meta.description });
  });
  google.script.run.withSuccessHandler(res => {
    btn.disabled = false; Busy.hide('params'); toast(res.ok ? 'Paramètres sauvegardés' : res.error);
  }).withFailureHandler(err => { btn.disabled = false; Busy.hide('params'); console.error('setParams', err); toast('Erreur sauvegarde'); })
    .setParams(sid, entries);
});

window.loadParamsForActiveSeason = loadParamsForActiveSeason;

</script>